<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>files</title>
        <link rel="stylesheet" href="./css/w3.css">
        <script src="./js/jquery-3.4.1.min.js"></script>
        <script src="./js/jquery.form.min.js"></script>
        <script src="./js/jsviews.min.js"></script>
        <script src="./js/evmsg.js"></script>
        <script src="./js/evmsg.tmpl.js"></script>
        <script src="./js/login.js"></script>
	<script src="./js/display-buckets-list.js"></script>
	<script src="./js/upload.js"></script>
        <script>
            $(document).ready(function(){
		    EVLogin({
			    onSend:function(obj){
				    var connID = EVMsg.login({
					    url: "ws://192.168.178.91:7878/v0.0.1/ws",
					    id: obj.username(),
					    secret:obj.password(),
					    scope: "Login",
					    command: "getToken",
					    onSuccess: function(json){
						    EVMsg.send(connID,{scope:"Bucket",command: "getList",token:json.data[0].token},function(resp){
							    EVDisplayBucketsList({
							    	target:"container",
								data: resp.data,
								helpers: {
									onGallery: function(event,obj){
										console.log(event,obj);
										EVMsg.send(connID,EVMsg.newMessage({scope:"Object",command:"getList",token: json.data[0].token,data:[{bucket:obj.linkCtx.data.name(),prefix:""}]}),function(objects){
											$.each(objects.data, function(idx,val){
											//	$("#img").append("<img src=\"/v0.0.1/files/buckets/"+obj.linkCtx.data.name()+"/objects/"+val.key+"\"><br>");
												$("#img").append("<img src=\"/v0.0.1/files/buckets/"+obj.linkCtx.data.name()+"/thumbnails/"+val.key+"\"><br>");
											});
										});
									},
									onUpload: function(event,obj){
										console.log(obj);
										EVUpload({target: "container",helpers:{upload:function(event,obj){
											event.preventDefault();
											console.log("upload",obj);
											var fData = new FormData()
											fData.append("file", obj.linkCtx.elem[1].files[0]);
											console.log(fData);
											$.ajax({
												url:"/v0.0.1/files/buckets/"+obj.linkCtx.elem[0].value+"/objects",
												type: "POST",
												data: fData,
												processData: false,
												contentType: false,
												success: function(resp){
													console.log(resp);
												},
												error: function(xhr,err,txt){
													console.log(xhr,err,txt);
												}

											});
										}}});
									}
								}
							    });
						    });
						   /* $.post(url: "http://192.168.178.91:7878/v0.0.1/files/buckets/test/objects");
						    if (json.debug.error == ""){
						    	$.get("http://192.168.178.91:7878/v0.0.1/files/buckets/test/objects/test.jpg")
						   	.done(function(data){console.log(data)})
							.fail(function(xhr,err,msg){
							    console.log(xhr,err,msg);
						    	});
						    }else{
					    		console.log(json);
						    }
						    */
					    }
				    });
			    },
			    target:"container",
			    data:{
				    labelUserName:"username",
				    labelPass:"password",
				    username:"",
				    password:""
			    }
		    });
            });
        </script>
    </head>
    <body>
	    <div id="container"></div>
	    <div id="img"></div>
    </body>
</html>
